name: Update IPTV Sources Separately

on:
  schedule:
    - cron: '0 */2 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-iptv:
    runs-on: ubuntu-latest

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      # ==========================================
      # 管道 1：专门处理 M3U 格式
      # ==========================================
      - name: 合并 M3U 源文件
        run: |
          # 1. 写入标准的 M3U 文件头
          echo "#EXTM3U" > all_live.m3u
          
          # 2. 逐个下载 list_m3u.txt 中的链接
          if [ -f list_m3u.txt ]; then
            while IFS= read -r url || [ -n "$url" ]; do
              if [[ -n "$url" && "$url" != \#* ]]; then
                echo "正在处理 M3U 源: $url"
                # 下载并严格过滤掉多余的 #EXTM3U 头，防止格式损坏
                curl -sL "$url" | grep -v "#EXTM3U" >> all_live.m3u
                echo "" >> all_live.m3u
              fi
            done < list_m3u.txt
          fi

      # ==========================================
      # 管道 2：专门处理 TXT 格式
      # ==========================================
      - name: 合并 TXT 源文件
        run: |
          # 1. 清空或创建 TXT 文件
          > all_live.txt
          
          # 2. 逐个下载 list_txt.txt 中的链接
          if [ -f list_txt.txt ]; then
            while IFS= read -r url || [ -n "$url" ]; do
              if [[ -n "$url" && "$url" != \#* ]]; then
                echo "正在处理 TXT 源: $url"
                # 直接追加下载内容，TXT格式不需要过滤文件头
                curl -sL "$url" >> all_live.txt
                echo "" >> all_live.txt
              fi
            done < list_txt.txt
          fi

      # ==========================================
      # 统一替换内网代理地址
      # ==========================================
      - name: 替换为我的 UDPXY 代理地址 (192.168.1.253:8001)
        run: |
          # 分别对两个文件进行正则替换，互不影响
          sed -E -i 's|http://[^/]+/|http://192.168.1.253:8001/|g' all_live.m3u
          sed -E -i 's|http://[^/]+/|http://192.168.1.253:8001/|g' all_live.txt
          
          # 删除空行，保持文件整洁
          sed -i '/^$/d' all_live.m3u
          sed -i '/^$/d' all_live.txt
          echo "✅ 代理地址替换完成！"

      # ==========================================
      # 提交保存
      # ==========================================
      - name: 提交并推送
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add all_live.m3u all_live.txt
          if ! git diff --staged --quiet; then
            git commit -m "独立更新并合并 M3U 和 TXT 源"
            git push
            echo "✅ 两个独立文件已更新成功。"
          fi
