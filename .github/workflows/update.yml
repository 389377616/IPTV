name: Update IPTV Sources Separately

on:
  schedule:
    - cron: '0 */2 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-iptv:
    runs-on: ubuntu-latest

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      # ==========================================
      # 管道 1：处理 M3U (支持 "名字,网址" 格式)
      # ==========================================
      - name: 合并 M3U 源文件
        run: |
          echo "#EXTM3U" > all_live.m3u
          
          if [ -f list_m3u.txt ]; then
            while IFS= read -r line || [ -n "$line" ]; do
              # 过滤空行和注释
              if [[ -n "$line" && "$line" != \#* ]]; then
                # 核心修复：只取最后一个逗号后面的内容作为纯 URL
                url="${line##*,}"
                # 清除可能存在的 Windows 回车符(\r)和首尾空格
                url=$(echo "$url" | tr -d '\r' | xargs)
                
                echo "正在下载 M3U 源: $url"
                # 增加 --fail 参数，如果网址失效不中断整个流程
                curl --fail -sL "$url" | grep -v "#EXTM3U" >> all_live.m3u || echo "⚠️ 下载失败，跳过: $url"
                echo "" >> all_live.m3u
              fi
            done < list_m3u.txt
          fi

      # ==========================================
      # 管道 2：处理 TXT (同样支持 "名字,网址" 格式)
      # ==========================================
      - name: 合并 TXT 源文件
        run: |
          > all_live.txt
          
          if [ -f list_txt.txt ]; then
            while IFS= read -r line || [ -n "$line" ]; do
              if [[ -n "$line" && "$line" != \#* ]]; then
                # 核心修复：只取纯 URL
                url="${line##*,}"
                url=$(echo "$url" | tr -d '\r' | xargs)
                
                echo "正在下载 TXT 源: $url"
                curl --fail -sL "$url" >> all_live.txt || echo "⚠️ 下载失败，跳过: $url"
                echo "" >> all_live.txt
              fi
            done < list_txt.txt
          fi

      # ==========================================
      # 替换内网代理地址
      # ==========================================
      - name: 替换为我的 UDPXY 代理地址
        run: |
          sed -E -i 's|http://[^/]+/|http://192.168.1.253:8001/|g' all_live.m3u
          sed -E -i 's|http://[^/]+/|http://192.168.1.253:8001/|g' all_live.txt
          
          sed -i '/^$/d' all_live.m3u
          sed -i '/^$/d' all_live.txt
          echo "✅ 代理地址替换完成！"

      # ==========================================
      # 提交保存
      # ==========================================
      - name: 提交并推送
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add all_live.m3u all_live.txt
          if ! git diff --staged --quiet; then
            git commit -m "修复网址提取逻辑并合并源"
            git push
            echo "✅ 修复成功，文件已更新。"
          fi
