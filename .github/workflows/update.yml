name: Update IPTV Sources

on:
  schedule:
    # 定时任务：每天北京时间早上 6 点自动运行 (GitHub 使用 UTC 时间，比北京时间晚 8 小时)
    - cron: '0 */2 * * *'
  workflow_dispatch: # 允许你在 GitHub 页面上手动点击按钮运行

permissions:
  contents: write # 赋予 GitHub Actions 写入仓库的权限，否则无法保存文件

jobs:
  update-iptv:
    runs-on: ubuntu-latest

    steps:
      - name: 检出代码 (Checkout)
        uses: actions/checkout@v4

      - name: 下载直播源 (Download Source)
        run: |
          # 【注意】请将下面引号里的 URL 替换为你真正想要抓取的直播源网址
          # -o iptv.m3u 表示将下载的内容保存到名为 iptv.m3u 的文件中
          curl -L -o iptv.m3u "https://example.com/other-people-source.m3u"

      - name: 替换为我的 UDPXY 代理地址 (Replace UDPXY)
        run: |
          # 这里会自动查找文件里的任意代理地址，并替换为你的 192.168.1.253:8001
          sed -E -i 's|http://[^/]+/|http://192.168.1.253:8001/|g' iptv.m3u
          echo "✅ 代理地址替换完成！"

      - name: 提交并推送更改 (Commit and Push)
        run: |
          # 设置虚拟机器人的提交身份
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # 检查文件是否有更新，如果有，则提交并推送到仓库
          if [[ -n $(git status -s) ]]; then
            git add iptv.m3u
            git commit -m "自动更新直播源并替换内网代理地址"
            git push
            echo "✅ 文件已更新并推送成功！"
          else
            echo "⚠️ 直播源没有变化，跳过提交。"
          fi
